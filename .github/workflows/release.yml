name: Auto Create Release

on:
  push:
    branches: [ main, master ]
    # paths:
    #   - 'Setup-DevDriveCache.ps1'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force create release even if tag exists'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-and-release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tag checking

    - name: Extract version from script
      id: extract_version
      shell: pwsh
      run: |
        $versionLine = Select-String -Path "Setup-DevDriveCache.ps1" -Pattern "\$script:ScriptVersion = "
        if ($versionLine) {
          $version = $versionLine.Line -replace '.*"([^"]+)".*', '$1'
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag_name=v$version" >> $env:GITHUB_OUTPUT
          echo "Extracted version: $version"
        } else {
          echo "Version not found in script"
          exit 1
        }

    - name: Check if tag exists
      id: check_tag
      shell: pwsh
      run: |
        $tagName = "v${{ env.VERSION }}"
        $existingTag = git tag -l $tagName
        if ($existingTag) {
          echo "Tag $tagName already exists"
          echo "tag_exists=true" >> $env:GITHUB_OUTPUT
        } else {
          echo "Tag $tagName does not exist"
          echo "tag_exists=false" >> $env:GITHUB_OUTPUT
        }

    - name: Check for forced release
      id: check_force
      if: github.event_name == 'workflow_dispatch'
      shell: pwsh
      run: |
        $forceRelease = "${{ github.event.inputs.force_release }}"
        echo "force_release=$forceRelease" >> $env:GITHUB_OUTPUT

    - name: Skip release if tag exists
      if: steps.check_tag.outputs.tag_exists == 'true' && (github.event_name != 'workflow_dispatch' || steps.check_force.outputs.force_release != 'true')
      shell: pwsh
      run: |
        echo "Release skipped: Tag v${{ env.VERSION }} already exists"
        echo "To force create a release, run the workflow manually with 'Force create release' option"

    - name: Create and push tag
      if: steps.check_tag.outputs.tag_exists == 'false' || (github.event_name == 'workflow_dispatch' && steps.check_force.outputs.force_release == 'true')
      shell: pwsh
      run: |
        $tagName = "v${{ env.VERSION }}"
        echo "Creating tag: $tagName"

        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Create annotated tag
        git tag -a $tagName -m "Release version ${{ env.VERSION }}"

        # Push tag
        git push origin $tagName

        echo "Tag $tagName created and pushed successfully"

    - name: Create Release
      if: steps.check_tag.outputs.tag_exists == 'false' || (github.event_name == 'workflow_dispatch' && steps.check_force.outputs.force_release == 'true')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.extract_version.outputs.tag_name }}
        name: Dev Drive Cache Migration Script v${{ env.VERSION }}
        body: |
          ## Dev Drive Cache Migration Script v${{ env.VERSION }}

          This PowerShell script helps developers migrate their package caches to Dev Drive for improved performance on Windows 11.

          ### Features
          - Interactive menu system for cache migration
          - Support for multiple Dev Drives with automatic selection
          - Safe migration with rollback capabilities
          - Restore functionality to return caches to original locations
          - Debug mode for testing and troubleshooting
          - Comprehensive hidden folder scanning and migration
          - Automatic symlink/junction creation with fallback support

          ### Supported Cache Types
          - Node.js (npm, yarn, pnpm)
          - Python (pip)
          - .NET (NuGet)
          - Java (Maven, Gradle)
          - Go (Go modules)
          - Rust (Cargo)
          - VS Code extensions
          - Windows TEMP/TMP directories
          - JetBrains IDE cache
          - Android SDK cache
          - Chocolatey cache
          - Hidden folders (.xxx)

          ### Requirements
          - Windows 11 (Build 22000 or higher)
          - PowerShell 7+ (pwsh)
          - Dev Drive (ReFS filesystem)

          ### Usage
          ```powershell
          pwsh.exe -File Setup-DevDriveCache.ps1
          ```

          ### Parameters
          - `-DevDrivePath "D:\"` - Specify Dev Drive path
          - `-DebugMode` - Enable debug mode
          - `-Lang "en"` - Set language (en/zh)
          - `-Version` - Show version info

          **Note**: This script only migrates cache folders using symbolic links and does not modify environment variables.
        files: |
          Setup-DevDriveCache.ps1
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload PowerShell Script as Artifact
      if: steps.check_tag.outputs.tag_exists == 'false' || (github.event_name == 'workflow_dispatch' && steps.check_force.outputs.force_release == 'true')
      uses: actions/upload-artifact@v4
      with:
        name: DevDriveCacheScript-v${{ env.VERSION }}
        path: |
          Setup-DevDriveCache.ps1
        retention-days: 30